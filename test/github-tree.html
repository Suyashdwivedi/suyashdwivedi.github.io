<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Indexer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex items-center justify-between px-4 py-3 bg-slate-800 border-b border-slate-700 shadow-md z-30">
        <div class="flex items-center gap-3">
            <i data-lucide="github" class="w-6 h-6 text-white"></i>
            <h1 class="text-lg font-bold hidden sm:block">GitHub Indexer</h1>
        </div>

        <form id="search-form" class="flex-1 max-w-xl mx-4 relative">
            <input
                id="username-input"
                type="text"
                placeholder="Enter GitHub Username..."
                class="w-full pl-10 pr-4 py-2 bg-slate-700 border border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder-slate-400"
            />
            <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-3"></i>
        </form>

        <div class="flex items-center gap-2">
            <button id="settings-btn" class="p-2 rounded-lg transition-colors hover:bg-slate-700 text-slate-300">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
            <button id="menu-btn" class="p-2 md:hidden hover:bg-slate-700 rounded-lg text-slate-300">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Settings Panel -->
    <div id="settings-panel" class="hidden bg-slate-800 border-b border-slate-700 p-4 transition-all duration-300">
        <div class="max-w-3xl mx-auto flex flex-col gap-2">
            <label class="text-sm text-slate-400">GitHub Personal Access Token (Optional - Increases Rate Limit)</label>
            <input 
                id="token-input"
                type="password" 
                placeholder="ghp_xxxxxxxxxxxx"
                class="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded text-sm focus:outline-none focus:border-blue-500 text-white"
            />
            <p class="text-xs text-slate-500">
                Without a token, you are limited to 60 requests/hour. Your token is not saved remotely.
            </p>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- Sidebar: Repositories -->
        <aside id="sidebar" class="absolute md:relative z-20 md:z-0 w-full md:w-80 h-full bg-slate-800 border-r border-slate-700 flex flex-col transition-transform duration-300 -translate-x-full md:translate-x-0">
            <div class="p-4 border-b border-slate-700 font-semibold text-slate-300 flex justify-between items-center">
                <span id="repo-count">Repositories (0)</span>
                <button id="close-sidebar" class="md:hidden p-1 hover:bg-slate-700 rounded">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div id="repo-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Repo items will be injected here -->
                <div class="text-center p-8 text-slate-500 text-sm">No repositories found.</div>
            </div>
            
            <!-- Sidebar Loader -->
            <div id="repo-loader" class="hidden flex justify-center p-8">
                <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-blue-500"></i>
            </div>
        </aside>

        <!-- Right Panel: File Explorer -->
        <main class="flex-1 flex flex-col bg-slate-900 w-full overflow-hidden relative">
            
            <!-- Error Toast -->
            <div id="error-toast" class="hidden absolute top-4 left-4 right-4 bg-red-900/90 border border-red-500/50 text-red-100 p-3 rounded-lg flex items-center gap-2 z-50 shadow-lg backdrop-blur-sm">
                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                <span id="error-message">Error message here</span>
                <button onclick="hideError()" class="ml-auto hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- Welcome State -->
            <div id="welcome-view" class="flex-1 flex flex-col items-center justify-center text-slate-600 p-4 text-center h-full">
                <i data-lucide="github" class="w-20 h-20 mb-4 opacity-20"></i>
                <h3 class="text-xl font-semibold mb-2">Select a Repository</h3>
                <p class="max-w-md">
                    Enter a GitHub username on the top left, then select a repository from the sidebar to browse its contents or generate a full file index.
                </p>
            </div>

            <!-- Repo Content View -->
            <div id="repo-content-view" class="hidden flex flex-col h-full">
                
                <!-- Toolbar -->
                <div class="bg-slate-800/50 border-b border-slate-700 p-4 flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
                    <div>
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <span id="repo-name-display">Repo Name</span>
                            <span id="repo-visibility" class="text-xs px-2 py-0.5 rounded-full bg-slate-700 text-slate-300 border border-slate-600">Public</span>
                        </h2>
                        <p id="repo-desc-display" class="text-slate-400 text-sm mt-1">Description...</p>
                    </div>

                    <div class="flex bg-slate-700 p-1 rounded-lg">
                        <button id="btn-browser-mode" class="px-3 py-1.5 text-sm rounded-md transition-all flex items-center gap-2 bg-slate-600 text-white shadow">
                            <i data-lucide="folder" class="w-4 h-4"></i> Browser
                        </button>
                        <button id="btn-index-mode" class="px-3 py-1.5 text-sm rounded-md transition-all flex items-center gap-2 text-slate-400 hover:text-white">
                            <i data-lucide="file-text" class="w-4 h-4"></i> Full Index
                        </button>
                    </div>
                </div>

                <!-- Views Container -->
                <div class="flex-1 overflow-hidden relative">
                    
                    <!-- BROWSER MODE -->
                    <div id="view-browser" class="h-full flex flex-col">
                        <!-- Breadcrumbs -->
                        <div class="px-4 py-2 bg-slate-800/30 border-b border-slate-700/50 text-sm font-mono text-slate-300 flex items-center gap-2 overflow-x-auto whitespace-nowrap">
                            <span class="text-blue-400 font-bold cursor-pointer hover:underline" onclick="navigateToRoot()">root</span>
                            <span id="breadcrumbs-container" class="flex items-center gap-2"></span>
                        </div>

                        <div class="flex-1 overflow-y-auto p-4 relative">
                            <!-- File Loader -->
                            <div id="file-loader" class="hidden absolute inset-0 flex items-center justify-center bg-slate-900/50 z-10">
                                <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-blue-500"></i>
                            </div>

                            <div id="file-list" class="grid grid-cols-1 gap-1">
                                <!-- Files injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- INDEX MODE -->
                    <div id="view-index" class="hidden h-full flex flex-col">
                        <div class="px-4 py-2 bg-slate-800/30 border-b border-slate-700/50 text-sm flex justify-between items-center">
                            <span class="text-slate-400">Recursive index of all files</span>
                            <button onclick="copyIndexToClipboard()" class="flex items-center gap-1 text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded text-slate-300 hover:text-white transition-colors">
                                <i data-lucide="copy" class="w-3 h-3"></i> Copy All Paths
                            </button>
                        </div>

                        <div class="flex-1 overflow-y-auto p-0 bg-slate-950 relative">
                             <!-- Tree Loader -->
                             <div id="tree-loader" class="hidden flex flex-col items-center justify-center h-40 gap-3">
                                <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-green-500"></i>
                                <span class="text-slate-400 text-sm">Fetching entire repository tree...</span>
                            </div>

                            <div id="tree-content" class="font-mono text-xs p-4">
                                <!-- Tree injected here -->
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <script>
        // --- State Management ---
        const state = {
            username: '',
            token: '',
            repos: [],
            selectedRepo: null,
            viewMode: 'browser', // 'browser' | 'index'
            currentPath: '',
            pathHistory: [],
            files: [],
            fullTree: [],
            loading: false
        };

        // --- Helper: Icons ---
        function renderIcons() {
            lucide.createIcons();
        }

        // --- Helper: API Headers ---
        function getHeaders() {
            return state.token ? { 'Authorization': `token ${state.token}` } : {};
        }

        // --- UI Updates ---
        function showError(msg) {
            const el = document.getElementById('error-toast');
            document.getElementById('error-message').innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => {
                el.classList.add('hidden');
            }, 5000);
        }

        function hideError() {
            document.getElementById('error-toast').classList.add('hidden');
        }

        function toggleSidebar(show) {
            const sb = document.getElementById('sidebar');
            if (show) {
                sb.classList.remove('-translate-x-full');
            } else {
                sb.classList.add('-translate-x-full');
            }
        }

        // --- Feature: Repositories ---
        async function fetchRepos(e) {
            if (e) e.preventDefault();
            const username = document.getElementById('username-input').value.trim();
            if (!username) return;

            state.username = username;
            state.selectedRepo = null;
            state.repos = [];
            updateRepoListUI(true); // Loading state
            toggleSidebar(true); // Open sidebar on mobile

            try {
                const response = await fetch(
                    `https://api.github.com/users/${username}/repos?sort=updated&per_page=100&type=public`,
                    { headers: getHeaders() }
                );

                if (!response.ok) {
                    if (response.status === 403) throw new Error("API Rate limit exceeded. Please add a Token.");
                    if (response.status === 404) throw new Error("User not found.");
                    throw new Error("Failed to fetch repositories.");
                }

                state.repos = await response.json();
                updateRepoListUI(false);
            } catch (err) {
                showError(err.message);
                updateRepoListUI(false, true); // Error state
            }
        }

        function updateRepoListUI(isLoading, isError = false) {
            const container = document.getElementById('repo-list');
            const loader = document.getElementById('repo-loader');
            const countLabel = document.getElementById('repo-count');

            if (isLoading) {
                container.innerHTML = '';
                loader.classList.remove('hidden');
                return;
            }

            loader.classList.add('hidden');
            countLabel.innerText = `Repositories (${state.repos.length})`;

            if (isError || state.repos.length === 0) {
                container.innerHTML = `<div class="text-center p-8 text-slate-500 text-sm">${isError ? 'Error loading repos.' : 'No repositories found.'}</div>`;
                return;
            }

            container.innerHTML = state.repos.map(repo => `
                <button onclick="selectRepo(${repo.id})" 
                    class="w-full text-left px-3 py-3 rounded-md flex flex-col gap-1 transition-all ${state.selectedRepo?.id === repo.id ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-700 hover:text-white'}">
                    <div class="flex items-center gap-2 w-full">
                        <i data-lucide="folder" class="w-4 h-4 flex-shrink-0 ${state.selectedRepo?.id === repo.id ? 'text-white' : 'text-slate-400'}"></i>
                        <span class="truncate text-sm font-medium">${repo.name}</span>
                    </div>
                    <div class="flex items-center gap-4 text-xs ml-6 ${state.selectedRepo?.id === repo.id ? 'text-blue-100' : 'text-slate-500'}">
                        <span class="flex items-center gap-1"><i data-lucide="star" class="w-3 h-3"></i> ${repo.stargazers_count}</span>
                        <span class="flex items-center gap-1"><i data-lucide="git-fork" class="w-3 h-3"></i> ${repo.forks_count}</span>
                    </div>
                </button>
            `).join('');
            
            renderIcons();
        }

        function selectRepo(repoId) {
            const repo = state.repos.find(r => r.id === repoId);
            if (!repo) return;

            state.selectedRepo = repo;
            state.pathHistory = [];
            state.currentPath = '';
            state.files = [];
            state.fullTree = [];
            
            // UI Updates
            updateRepoListUI(false); // Re-render to highlight selection
            document.getElementById('welcome-view').classList.add('hidden');
            document.getElementById('repo-content-view').classList.remove('hidden');
            
            // Header Info
            document.getElementById('repo-name-display').innerText = repo.name;
            document.getElementById('repo-visibility').innerText = repo.private ? 'Private' : 'Public';
            document.getElementById('repo-desc-display').innerText = repo.description || 'No description provided.';

            // Reset View Mode to Browser
            switchViewMode('browser');
            
            // Fetch root
            fetchFiles('');

            // Mobile: Close sidebar
            if (window.innerWidth < 768) toggleSidebar(false);
        }

        // --- Feature: File Browser ---
        async function fetchFiles(path) {
            const loader = document.getElementById('file-loader');
            loader.classList.remove('hidden');
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${state.username}/${state.selectedRepo.name}/contents/${path}`,
                    { headers: getHeaders() }
                );

                if (!response.ok) throw new Error("Failed to fetch files.");

                let data = await response.json();
                
                // If single file content (rare case if clicking file that API returns as content object), array-ify it
                if (!Array.isArray(data)) data = [data];

                // Sort: Folders first
                state.files = data.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'dir' ? -1 : 1;
                });
                state.currentPath = path;
                
                updateBrowserUI();
            } catch (err) {
                showError(err.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function handleFolderClick(folderName) {
            const newPath = state.currentPath ? `${state.currentPath}/${folderName}` : folderName;
            state.pathHistory.push(state.currentPath);
            fetchFiles(newPath);
        }

        function handleBack() {
            if (state.pathHistory.length === 0) return;
            const prevPath = state.pathHistory.pop();
            fetchFiles(prevPath);
        }

        function navigateToRoot() {
            state.pathHistory = [];
            fetchFiles('');
        }

        function updateBrowserUI() {
            const container = document.getElementById('file-list');
            const breadcrumbs = document.getElementById('breadcrumbs-container');
            
            // Render Breadcrumbs
            if (state.currentPath) {
                breadcrumbs.innerHTML = `<span class="text-slate-500">/</span> <span class="text-slate-300">${state.currentPath}</span>`;
            } else {
                breadcrumbs.innerHTML = '';
            }

            // Render Files
            let html = '';
            
            // Back Button
            if (state.pathHistory.length > 0 || state.currentPath !== '') {
                html += `
                    <button onclick="handleBack()" class="flex items-center gap-3 p-3 rounded-md hover:bg-slate-800 text-slate-400 hover:text-blue-400 transition-colors text-left w-full">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span class="font-medium">..</span>
                    </button>
                `;
            }

            if (state.files.length === 0) {
                html += `<div class="text-center py-10 text-slate-500">Empty directory</div>`;
            } else {
                html += state.files.map(file => {
                    const isDir = file.type === 'dir';
                    const iconClass = isDir ? 'text-yellow-500 group-hover:text-yellow-400' : 'text-slate-400 group-hover:text-blue-400';
                    const iconName = isDir ? 'folder' : 'file';
                    const clickAction = isDir ? `handleFolderClick('${file.name}')` : `window.open('${file.html_url}', '_blank')`;
                    const sizeText = file.size > 0 ? (file.size / 1024).toFixed(1) + ' KB' : '';
                    
                    return `
                        <div class="group flex items-center justify-between p-3 rounded-md hover:bg-slate-800 border border-transparent hover:border-slate-700 transition-all">
                            <button onclick="${clickAction}" class="flex-1 flex items-center gap-3 text-left">
                                <i data-lucide="${iconName}" class="w-5 h-5 ${iconClass}"></i>
                                <span class="text-sm ${isDir ? 'font-semibold text-slate-200' : 'text-slate-300'}">${file.name}</span>
                            </button>
                            <div class="flex items-center gap-4 text-xs text-slate-500">
                                <span>${sizeText}</span>
                                ${!isDir ? `
                                    <a href="${file.html_url}" target="_blank" class="p-1 hover:bg-slate-700 rounded text-slate-400 hover:text-white" title="Open on GitHub">
                                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            container.innerHTML = html;
            renderIcons();
        }

        // --- Feature: Full Index (Recursive Tree) ---
        async function fetchFullTree() {
            const loader = document.getElementById('tree-loader');
            const content = document.getElementById('tree-content');
            
            loader.classList.remove('hidden');
            content.innerHTML = '';

            try {
                const branch = state.selectedRepo.default_branch || 'main';
                const response = await fetch(
                    `https://api.github.com/repos/${state.username}/${state.selectedRepo.name}/git/trees/${branch}?recursive=1`,
                    { headers: getHeaders() }
                );

                if (!response.ok) {
                    if (response.status === 409) throw new Error("Repo is empty or too large.");
                    throw new Error("Failed to fetch tree.");
                }

                const data = await response.json();
                if (data.truncated) showError("Warning: Tree truncated (too large).");
                
                state.fullTree = data.tree || [];
                renderTree();
            } catch (err) {
                showError(err.message);
                content.innerHTML = `<div class="text-slate-500 p-4">Failed to load tree.</div>`;
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderTree() {
            const container = document.getElementById('tree-content');
            if (state.fullTree.length === 0) {
                container.innerHTML = `<div class="text-slate-500 p-4">No data.</div>`;
                return;
            }

            const html = state.fullTree.map((item, idx) => `
                <div class="flex gap-2 py-0.5 hover:bg-slate-900 group">
                    <span class="text-slate-600 w-8 text-right select-none">${idx + 1}</span>
                    <span class="${item.type === 'tree' ? 'text-blue-400 font-bold' : 'text-slate-300'}">${item.path}</span>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function copyIndexToClipboard() {
            if (state.fullTree.length === 0) return;
            const text = state.fullTree.map(f => f.path).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('#view-index button span'); // naive selection
                // Optional visual feedback could go here
                alert("Copied to clipboard!"); 
            });
        }

        // --- View Switching ---
        function switchViewMode(mode) {
            state.viewMode = mode;
            const btnBrowser = document.getElementById('btn-browser-mode');
            const btnIndex = document.getElementById('btn-index-mode');
            const viewBrowser = document.getElementById('view-browser');
            const viewIndex = document.getElementById('view-index');

            if (mode === 'browser') {
                btnBrowser.className = "px-3 py-1.5 text-sm rounded-md transition-all flex items-center gap-2 bg-slate-600 text-white shadow";
                btnIndex.className = "px-3 py-1.5 text-sm rounded-md transition-all flex items-center gap-2 text-slate-400 hover:text-white";
                viewBrowser.classList.remove('hidden');
                viewIndex.classList.add('hidden');
            } else {
                btnIndex.className = "px-3 py-1.5 text-sm rounded-md transition-all flex items-center gap-2 bg-slate-600 text-white shadow";
                btnBrowser.className = "px-3 py-1.5 text-sm rounded-md transition-all flex items-center gap-2 text-slate-400 hover:text-white";
                viewIndex.classList.remove('hidden');
                viewBrowser.classList.add('hidden');
                
                if (state.fullTree.length === 0) {
                    fetchFullTree();
                }
            }
        }

        // --- Event Listeners ---
        document.getElementById('search-form').addEventListener('submit', fetchRepos);
        
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-panel').classList.toggle('hidden');
        });

        document.getElementById('token-input').addEventListener('input', (e) => {
            state.token = e.target.value;
        });

        document.getElementById('menu-btn').addEventListener('click', () => {
            toggleSidebar(true);
        });

        document.getElementById('close-sidebar').addEventListener('click', () => {
            toggleSidebar(false);
        });

        document.getElementById('btn-browser-mode').addEventListener('click', () => switchViewMode('browser'));
        document.getElementById('btn-index-mode').addEventListener('click', () => switchViewMode('index'));

        // Init
        renderIcons();
    </script>
</body>
</html>