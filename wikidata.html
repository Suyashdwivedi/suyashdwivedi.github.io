<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Female Scientists from Asia</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/d3/dist/d3.min.js" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #loading {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }

        #loading img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
        }

        #map {
            height: 500px;
            width: 100%;
        }

        #data {
            margin-top: 20px;
            width: 80%;
            border-collapse: collapse;
        }

        #data th, #data td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #data th {
            background-color: #f2f2f2;
        }

        .button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }

        .button:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>

    <div id="loading">
        <img src="https://i.gifer.com/4Q1t.gif" alt="Loading..."> <!-- Loading GIF -->
        <span>Loading data, please wait...</span>
    </div>
    
    <div id="map"></div>

    <button class="button" onclick="location.reload();">Refresh</button> <!-- Refresh button -->

    <table id="data">
        <thead>
            <tr>
                <th>No</th>
                <th>Name</th>
                <th>Field</th>
                <th>Birthplace</th>
                <th>Country</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated here -->
        </tbody>
    </table>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/d3/dist/d3.min.js"></script>
    <script>
        // Function to hide loading GIF and show content
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        const sparqlQuery = `
        SELECT ?scientist ?scientistLabel ?fieldLabel ?placeLabel ?placeCoord ?article ?image ?countryLabel WHERE {
          ?scientist wdt:P31 wd:Q5;             # Entity must be a human
                    wdt:P106 wd:Q901;           # Occupation must be a scientist
                    wdt:P21 wd:Q6581072;        # Gender must be female
                    wdt:P27 ?country;           # Nationality should be from an Asian country
                    wdt:P101 ?field;            # Field of work property
                    wdt:P19 ?place.             # Place of birth property
          ?place wdt:P625 ?placeCoord.          # Get coordinates for the birthplace
          ?country wdt:P30 wd:Q48.              # Must be part of Asia (Q48 is the Wikidata ID for Asia)
          OPTIONAL { ?article schema:about ?scientist ; schema:inLanguage "en" ; schema:isPartOf <https://en.wikipedia.org/>. }
          OPTIONAL { ?scientist wdt:P18 ?image. } # Optional image property
          SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
        }
        LIMIT 500`;

        fetch("https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparqlQuery) + "&format=json")
            .then(response => response.json())
            .then(data => {
                const tableBody = d3.select("#data tbody");
                const scientistsData = data.results.bindings.map((person, index) => {
                    const coords = person.placeCoord.value.replace('Point(', '').replace(')', '').split(' ');
                    return {
                        name: person.scientistLabel?.value || "Unknown Scientist", // Use optional chaining and default value
                        field: person.fieldLabel?.value || "Field not available", // Use optional chaining and default value
                        birthplace: person.placeLabel?.value || "Birthplace not available", // Use optional chaining and default value
                        country: person.countryLabel?.value || "Country not available", // Use optional chaining and default value
                        coordinates: [parseFloat(coords[1]), parseFloat(coords[0])],
                        article: person.article?.value || null,
                        image: person.image?.value || "https://via.placeholder.com/150", // Placeholder image
                        wikidata: `https://www.wikidata.org/wiki/${person.scientist.value.split('/').pop()}` // Link to Wikidata
                    };
                });

                const uniqueScientists = {};
                scientistsData.forEach((scientist, index) => {
                    // Check if the scientist's name has already been added
                    if (!uniqueScientists[scientist.name]) {
                        uniqueScientists[scientist.name] = {
                            index: index,
                            field: scientist.field,
                            birthplace: scientist.birthplace,
                            country: scientist.country,
                            article: scientist.article,
                            image: scientist.image,
                            wikidata: scientist.wikidata,
                            coordinates: scientist.coordinates
                        };

                        // Append a table row with the serial number, scientist info, field, birthplace, and country
                        tableBody.append("tr")
                            .html(`<td>${index + 1}</td>
                                   <td><a href="${scientist.article || '#'}" target="_blank">${scientist.name}</a> (<a href="${scientist.wikidata}" target="_blank">Wikidata</a>)</td>
                                   <td>${scientist.field}</td>
                                   <td>${scientist.birthplace}</td>
                                   <td>${scientist.country}</td>`);
                    }

                    // Add markers to the map for each unique scientist
                    const marker = L.marker(scientist.coordinates).addTo(map);
                    marker.bindPopup(`<b>${scientist.name}</b><br>${scientist.field}<br>${scientist.birthplace}<br>${scientist.country}<br><a href="${scientist.article || '#'}" target="_blank">Wikipedia</a><br><img src="${scientist.image || 'https://via.placeholder.com/150'}" alt="${scientist.name}" width="50" height="50" style="border-radius: 50%;">`);
                });

                // Initialize the map
                const map = L.map('map').setView([20, 100], 4); // Centering on Asia

                // Set up the OSM layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);

                hideLoading(); // Hide the loading GIF when the content is fully loaded
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                hideLoading(); // Hide the loading GIF even if there's an error
            });
    </script>
</body>
</html>
