<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scientists Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        #map { height: 600px; }
        #data { margin-top: 20px; }
    </style>
</head>
<body>

<h1>Map of Scientists</h1>
<div id="map"></div>
<table id="data" border="1">
    <thead>
        <tr>
            <th>Name</th>
            <th>Field</th>
            <th>Place</th>
            <th>Article</th>
            <th>Image</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script src="https://unpkg.com/d3@5.16.0/dist/d3.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
    const sparqlQuery = `
        SELECT ?scientist ?scientistLabel ?fieldLabel ?placeLabel ?placeCoord ?article ?image ?countryLabel WHERE {
            ?scientist wdt:P31 wd:Q5;             
                        wdt:P106 wd:Q901;           
                        wdt:P21 wd:Q6581072;        
                        wdt:P27 ?country;           
                        wdt:P101 ?field;            
                        wdt:P19 ?place.             
            ?place wdt:P625 ?placeCoord.          
            OPTIONAL { ?article schema:about ?scientist ; schema:isPartOf <https://en.wikipedia.org/>. }
            OPTIONAL { ?scientist wdt:P18 ?image. } 
            SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
        } LIMIT 500
    `;

    fetch("https://query.wikidata.org/sparql?query=" + encodeURIComponent(sparqlQuery) + "&format=json")
        .then(response => response.json())
        .then(data => {
            console.log("Fetched Data:", data); // Log the fetched data
            const tableBody = d3.select("#data tbody");
            const scientistsData = data.results.bindings.map((person) => {
                const placeCoord = person.placeCoord ? person.placeCoord.value.match(/([-+]?[0-9]*\.?[0-9]+), ([-+]?[0-9]*\.?[0-9]+)/) : null;
                return {
                    name: person.scientistLabel.value,
                    field: person.fieldLabel ? person.fieldLabel.value : "Unknown",
                    place: person.placeLabel ? person.placeLabel.value : "Unknown",
                    coordinates: placeCoord ? [parseFloat(placeCoord[2]), parseFloat(placeCoord[1])] : null,
                    article: person.article ? person.article.value : "",
                    image: person.image ? person.image.value : "https://via.placeholder.com/150"
                };
            });

            console.log("Processed Scientists Data:", scientistsData); // Log processed scientists data
            const uniqueScientists = {};
            scientistsData.forEach((scientist) => {
                if (scientist.coordinates) {
                    uniqueScientists[scientist.name] = scientist;
                }
            });

            const map = L.map('map').setView([20, 100], 3); // Center on Asia

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            const markers = L.markerClusterGroup(); // Initialize marker cluster group
            Object.keys(uniqueScientists).forEach((scientistName) => {
                const scientist = uniqueScientists[scientistName];
                const marker = L.marker(scientist.coordinates);
                marker.bindPopup(`<strong>${scientist.name}</strong><br>Field: ${scientist.field}<br>Place: ${scientist.place}<br><img src="${scientist.image}" alt="${scientist.name}" style="width:50px;height:50px;"><br><a href="${scientist.article}" target="_blank">Wikipedia Article</a>`);
                markers.addLayer(marker); // Add marker to the cluster group
                console.log("Adding marker for:", scientistName, "at coordinates:", scientist.coordinates); // Log marker info
            });

            map.addLayer(markers); // Add markers to the map

            scientistsData.forEach(scientist => {
                const row = tableBody.append('tr');
                row.append('td').text(scientist.name);
                row.append('td').text(scientist.field);
                row.append('td').text(scientist.place);
                const link = row.append('td').append('a').attr('href', scientist.article).attr('target', '_blank').text('Link');
                row.append('td').append('img').attr('src', scientist.image).attr('width', 50).attr('height', 50);
            });
        })
        .catch(error => {
            console.error("Error fetching data:", error); // Log any errors
        });
</script>

</body>
</html>
